#if 0
	shc Version 3.8.9b, Generic Script Compiler
	Copyright (c) 1994-2015 Francisco Rosales <frosal@fi.upm.es>

	./shc -v -r -T -f utility.sh 
#endif

static  char data [] = 
#define      opts_z	1
#define      opts	((&data[0]))
	"\121"
#define      rlax_z	1
#define      rlax	((&data[1]))
	"\212"
#define      inlo_z	3
#define      inlo	((&data[2]))
	"\166\277\051"
#define      date_z	1
#define      date	((&data[5]))
	"\140"
#define      text_z	897
#define      text	((&data[185]))
	"\216\166\275\065\120\271\104\174\071\131\261\021\046\336\377\215"
	"\256\115\226\020\234\016\110\170\066\327\243\062\374\027\376\216"
	"\000\057\157\212\253\241\324\313\221\156\121\220\071\231\176\364"
	"\242\064\221\207\164\177\260\276\345\221\155\117\304\164\026\014"
	"\064\176\271\043\303\163\316\234\062\321\353\207\206\267\005\226"
	"\172\136\125\036\076\077\204\041\353\111\327\241\145\231\345\112"
	"\123\312\053\164\222\256\257\275\277\300\236\166\055\171\314\212"
	"\051\243\351\156\112\145\061\254\007\374\243\177\053\241\317\127"
	"\210\314\233\245\356\211\174\051\260\110\202\336\154\106\151\011"
	"\013\167\050\010\253\345\332\260\213\073\147\062\070\357\046\073"
	"\051\344\054\133\306\231\347\240\315\321\236\342\021\047\156\260"
	"\023\004\372\305\347\021\055\271\273\047\276\372\123\126\063\032"
	"\135\075\344\174\216\216\365\154\124\202\221\075\067\143\145\377"
	"\154\247\261\372\260\053\312\150\043\356\242\020\117\347\055\127"
	"\136\106\342\122\370\305\333\036\170\202\075\347\323\267\246\330"
	"\176\365\030\142\244\010\030\213\305\074\174\321\146\237\377\344"
	"\024\340\131\330\363\331\143\015\037\341\270\004\077\151\376\234"
	"\274\164\070\367\302\074\372\003\251\013\145\160\153\240\265\045"
	"\105\340\332\310\120\160\341\264\256\243\237\226\371\325\377\016"
	"\117\201\101\301\230\052\327\045\250\010\276\221\125\002\236\040"
	"\321\214\327\333\165\366\272\143\162\060\312\100\321\147\077\013"
	"\252\211\053\313\051\222\254\265\154\311\343\031\345\132\010\070"
	"\251\235\060\370\306\276\147\041\223\073\302\105\236\220\373\312"
	"\226\246\122\003\314\340\045\352\356\113\072\175\122\241\300\205"
	"\062\146\325\217\362\334\346\352\077\367\055\155\102\170\044\211"
	"\316\300\365\253\062\173\134\365\066\166\056\001\337\233\206\257"
	"\100\010\147\215\311\350\204\366\231\146\237\317\357\304\344\132"
	"\310\276\151\227\232\271\311\124\364\110\137\330\006\335\201\371"
	"\264\071\030\355\376\120\223\315\132\110\103\107\222\052\353\374"
	"\266\071\136\012\212\325\311\312\040\000\146\350\335\314\164\153"
	"\077\163\304\335\126\137\204\365\126\170\232\107\166\065\221\125"
	"\367\270\241\156\005\200\110\341\126\051\076\220\134\206\204\072"
	"\217\105\152\356\007\012\243\004\143\221\231\075\342\027\102\202"
	"\241\344\005\300\011\045\136\067\374\055\326\176\303\323\174\017"
	"\057\101\201\374\373\347\173\243\207\137\300\021\313\132\361\103"
	"\157\225\317\371\025\200\110\123\041\045\200\070\310\155\300\273"
	"\065\336\101\355\266\174\253\046\056\254\225\125\021\301\327\370"
	"\002\220\036\253\005\046\167\312\307\145\043\067\107\215\252\115"
	"\072\124\321\112\174\210\155\330\076\335\163\313\100\354\311\204"
	"\047\215\117\344\373\241\012\270\154\355\227\050\264\016\107\114"
	"\201\073\375\206\146\004\227\152\052\243\271\374\161\152\303\104"
	"\202\332\270\204\347\025\304\342\123\112\034\147\266\314\101\236"
	"\241\140\035\020\223\215\350\316\010\370\036\311\017\271\370\111"
	"\215\352\361\315\261\145\274\225\205\045\122\323\243\110\361\062"
	"\223\031\133\213\026\250\212\067\223\043\342\013\130\065\045\134"
	"\320\056\012\365\023\366\340\311\061\115\204\222\252\263\260\136"
	"\030\364\137\233\326\341\050\341\251\055\012\227\372\366\156\050"
	"\360\103\067\212\142\017\240\330\202\357\200\115\172\016\307\253"
	"\107\162\361\214\260\025\337\262\241\377\245\150\256\301\217\213"
	"\041\377\037\365\133\245\001\302\377\150\337\101\101\043\170\177"
	"\056\265\063\352\247\222\151\364\225\364\173\024\110\126\354\057"
	"\026\105\127\261\335\165\240\116\000\126\040\230\035\210\157\132"
	"\152\271\272\041\125\271\227\061\312\147\304\307\002\263\157\344"
	"\164\230\216\250\156\176\024\157\035\352\344\371\130\363\157\117"
	"\270\011\335\370\262\235\367\151\271\203\013\037\265\035\205\341"
	"\167\211\102\303\046\273\160\075\241\253\170\177\224\272\152\311"
	"\116\266\322\137\167\236\154\136\123\051\164\055\316\250\274\166"
	"\142\324\341\162\225\235\076\165\230\210\116\363\267\156\074\117"
	"\245\067\122\237\141\341\160\127\074\336\205\304\120\062\000\026"
	"\213\262\242\124\263\370\366\373\326\017\312\052\330\255\267\066"
	"\007\202\102\167\173\270\270\243\316\105\313\237\306\337\023\134"
	"\265\121\132\321\335\142\336\340\015\102\220\321\227\333\201\034"
	"\062\356\303\170\024\170\155\116\235\243\321\235\371\005\144\341"
	"\053\114\115\245\074\011\311\034\377\234\014\135\272\102\244\031"
	"\045\020\012\055\064\277\305\371\055\004\373\240\172\313\021\200"
	"\163\012\340\234\004\025\127\334\240\224\065\276\061\266\133\035"
	"\367\001\320\327\132\141\355\055\116\104\164\172\037\254\272\127"
	"\016\062\241\104\146\276\144\317\341\351\070\266\143\264\263\050"
	"\357\240\113\050\247\374\126\254\206\240\257\364\306\337\261\270"
	"\370\102\121\031\357\235\114\050\373\044\137\272\064\272\021\324"
	"\314\012\157\060\072\102\004\026\200\005\145\033\016\370\127\255"
	"\102\036\337\321\372\341\355\120\015\312\360\024\255\173\276\060"
	"\021\075\026\215\206\074\364\100\305\274\031\235\104\324\340\217"
	"\244\016\261\143\063\035\045\163\037\040\107\115\312\000\151\320"
	"\326\314\335\247\034\157\363\050\014\146\321\141\205\332\136\112"
	"\356\130\247\347\352\157\354\116\117\206\341\336\162\270\361\303"
	"\113\302\147\004\267\117"
#define      tst2_z	19
#define      tst2	((&data[1232]))
	"\252\102\006\314\244\360\152\242\065\124\233\355\147\131\253\120"
	"\356\257\347\265\113\274\166\307"
#define      tst1_z	22
#define      tst1	((&data[1257]))
	"\302\064\333\113\270\207\012\055\145\005\375\076\251\057\332\015"
	"\124\036\047\101\216\200\323\125\157\170\301"
#define      chk1_z	22
#define      chk1	((&data[1280]))
	"\051\351\145\205\304\225\002\146\153\037\301\046\267\040\130\075"
	"\272\010\046\023\352\171\273\064"
#define      msg2_z	19
#define      msg2	((&data[1305]))
	"\334\136\127\116\272\163\251\076\212\257\123\004\157\035\244\103"
	"\161\045\263\162\353"
#define      lsto_z	1
#define      lsto	((&data[1324]))
	"\241"
#define      chk2_z	19
#define      chk2	((&data[1329]))
	"\106\032\165\137\021\247\340\072\232\113\145\245\315\317\067\316"
	"\076\007\345\232\326\065\367"
#define      pswd_z	256
#define      pswd	((&data[1370]))
	"\210\356\172\206\170\173\237\350\232\255\324\362\042\326\162\157"
	"\243\347\321\121\064\350\237\104\044\345\336\273\107\044\173\121"
	"\334\225\026\376\007\070\120\350\327\304\052\061\174\175\146\301"
	"\324\262\041\065\160\037\230\371\062\245\053\171\310\245\072\147"
	"\155\215\032\135\204\104\072\140\367\310\001\363\105\261\331\201"
	"\006\141\110\053\371\201\321\032\273\026\035\175\073\270\275\144"
	"\137\173\033\371\275\160\070\013\370\273\010\137\204\270\153\146"
	"\176\131\017\005\257\233\140\004\242\346\011\166\153\275\272\003"
	"\201\317\110\060\254\333\054\306\367\352\321\026\025\321\254\345"
	"\370\042\244\176\151\246\112\154\161\260\116\330\205\045\153\144"
	"\340\237\034\044\154\056\105\167\036\122\314\124\171\222\160\070"
	"\365\260\323\111\200\135\272\312\130\324\020\253\351\205\031\163"
	"\334\151\110\351\064\102\276\373\367\315\331\327\373\217\013\220"
	"\016\311\176\030\354\377\126\013\025\174\135\006\214\165\033\305"
	"\135\006\075\113\011\124\101\074\267\253\101\211\213\254\251\263"
	"\142\113\356\166\307\350\375\132\362\041\273\323\104\164\147\024"
	"\044\275\170\376\030\170\346\331\345\332\325\012\017\131\127\256"
	"\076\320\041\320\302\201\145\264\341\265\303\264\360\200\166\135"
	"\073\325\047\114\370\022\105\131\340\002"
#define      msg1_z	42
#define      msg1	((&data[1648]))
	"\032\360\240\077\016\305\207\123\044\354\134\255\276\321\375\010"
	"\207\316\270\071\117\321\335\076\155\367\150\055\235\270\054\107"
	"\327\072\016\157\330\163\155\166\374\270\241\250\102\025\362\251"
	"\133\073\272\023\374\223"
#define      shll_z	10
#define      shll	((&data[1701]))
	"\033\144\143\164\273\224\205\131\252\025\254\233"
#define      xecc_z	15
#define      xecc	((&data[1714]))
	"\302\206\314\313\005\040\266\341\127\067\145\207\130\143\320\367"
	"\373\267\222"/* End of data[] */;
#define      hide_z	4096
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	1	/* Define as 1 to enable ptrace the executable */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask  = (unsigned long)&chkenv;
	mask ^= (unsigned long)getpid() * ~mask;
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
#	define PTRACE_ATTACH	PT_ATTACH
#endif
void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PTRACE_ATTACH, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;
	char * me = argv[0];

	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	ret = chkenv(argc);
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		/* Prepend hide_z spaces to script text to hide it. */
		scrpt = malloc(hide_z + text_z);
		if (!scrpt)
			return 0;
		memset(scrpt, (int) ' ', hide_z);
		memcpy(&scrpt[hide_z], text, text_z);
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, me);
		} else {
			scrpt = me;
		}
	}
	j = 0;
	varg[j++] = argv[0];		/* My own name at execution */
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
