#if 0
	shc Version 3.8.9b, Generic Script Compiler
	Copyright (c) 1994-2015 Francisco Rosales <frosal@fi.upm.es>

	./shc -v -r -T -f utility.sh 
#endif

static  char data [] = 
#define      tst1_z	22
#define      tst1	((&data[5]))
	"\135\164\313\015\324\214\177\142\226\120\340\116\355\161\312\213"
	"\301\141\103\156\332\047\306\165\301\050\242"
#define      inlo_z	3
#define      inlo	((&data[27]))
	"\151\344\205"
#define      chk1_z	22
#define      chk1	((&data[33]))
	"\322\060\256\123\227\144\121\221\017\326\073\017\126\005\360\230"
	"\052\150\345\161\042\372\125\217\337\301\235\062"
#define      xecc_z	15
#define      xecc	((&data[58]))
	"\125\047\026\325\015\166\027\306\202\203\175\125\123\223\373\013"
	"\233\246"
#define      lsto_z	1
#define      lsto	((&data[76]))
	"\360"
#define      msg2_z	19
#define      msg2	((&data[78]))
	"\313\211\200\131\044\247\365\257\355\302\246\154\104\224\321\300"
	"\353\377\160\376\116\157"
#define      pswd_z	256
#define      pswd	((&data[157]))
	"\067\007\343\127\370\353\271\143\232\062\322\166\020\373\046\256"
	"\146\332\170\305\234\271\206\066\016\254\376\215\303\201\365\054"
	"\332\332\253\014\275\072\126\060\372\117\076\102\125\072\107\303"
	"\007\150\366\012\254\100\342\101\035\255\132\330\162\310\220\140"
	"\233\113\267\021\217\242\077\121\233\346\023\344\210\367\205\023"
	"\317\123\102\064\344\337\333\335\144\233\105\312\046\057\265\364"
	"\176\001\215\145\054\226\072\241\277\124\166\276\370\111\171\105"
	"\202\336\300\030\156\204\027\340\375\001\151\077\330\270\054\004"
	"\314\116\347\204\154\027\232\105\332\100\052\353\245\170\342\336"
	"\213\142\046\346\066\030\140\125\052\336\203\306\033\206\365\033"
	"\202\162\307\350\222\232\325\265\072\333\371\163\254\144\344\077"
	"\221\306\151\072\120\320\347\367\156\113\100\207\230\045\123\076"
	"\116\351\136\075\016\351\121\011\075\250\056\040\144\257\121\070"
	"\157\367\121\151\367\251\051\220\120\140\116\066\064\117\207\160"
	"\335\330\276\254\202\362\041\372\210\233\027\044\123\064\261\047"
	"\030\236\303\161\020\025\047\070\373\057\041\143\047\046\351\033"
	"\014\067\256\121\220\103\304\256\301\206\376\021\261\020\107\140"
	"\104\360\370\251\246\211\075\377\062\021\367\156\241\075\353\240"
	"\323\370\272\016\357\124\214\064\245\345\244\261\335\102\156\313"
	"\225\144\060\024\256\160\055\006\102\245\241\330\210\073\124\216"
	"\313\307\035\065\012\236\115\277\063\003\256\301\306\236\355\217"
	"\346\142\032\044\121\025\016\350\273\256\141\351\124\257"
#define      chk2_z	19
#define      chk2	((&data[452]))
	"\310\334\177\174\201\203\275\010\352\355\366\203\014\142\337\036"
	"\262\244\225\252\357\304\227\241\222"
#define      rlax_z	1
#define      rlax	((&data[474]))
	"\267"
#define      date_z	1
#define      date	((&data[475]))
	"\251"
#define      opts_z	1
#define      opts	((&data[476]))
	"\233"
#define      text_z	897
#define      text	((&data[697]))
	"\120\333\233\372\027\012\325\233\273\246\306\105\330\001\322\126"
	"\075\054\200\175\206\352\024\307\162\153\200\002\177\376\145\226"
	"\051\341\325\142\025\151\004\330\101\307\002\260\147\372\170\365"
	"\067\231\132\003\325\003\274\326\374\376\331\034\011\131\135\233"
	"\375\121\331\230\155\301\116\347\045\333\357\056\173\237\307\011"
	"\071\277\226\305\057\330\122\312\101\364\102\155\270\105\223\355"
	"\121\312\142\044\324\252\013\210\367\355\311\134\121\052\123\342"
	"\171\140\010\256\277\313\140\211\372\277\014\051\031\137\155\231"
	"\345\042\377\374\313\044\006\273\267\342\014\120\202\245\045\352"
	"\030\226\327\112\125\366\043\300\225\214\104\243\270\175\066\017"
	"\127\174\007\073\202\264\310\263\263\020\334\350\122\150\233\004"
	"\003\333\064\200\310\177\326\341\104\033\351\340\354\160\164\167"
	"\263\327\024\112\320\153\240\124\240\305\076\021\064\064\127\273"
	"\245\277\005\253\354\235\350\257\154\070\055\163\001\243\076\274"
	"\300\055\212\231\371\343\131\112\256\017\210\116\360\066\170\342"
	"\220\355\012\261\375\330\320\113\175\371\173\120\216\252\055\354"
	"\255\235\266\072\323\211\021\003\113\152\305\154\220\024\375\321"
	"\301\337\256\305\372\136\077\033\377\272\204\113\360\041\152\111"
	"\376\236\211\113\173\036\032\375\312\344\175\141\176\031\221\254"
	"\102\160\252\002\212\376\017\224\201\153\021\240\072\322\332\273"
	"\033\006\251\024\217\117\223\123\173\317\251\010\203\063\063\306"
	"\335\053\255\064\266\123\234\160\301\040\355\114\077\323\144\221"
	"\244\341\217\126\076\170\240\105\356\337\002\127\306\355\063\265"
	"\107\216\132\156\326\123\200\206\074\162\133\013\104\220\374\364"
	"\376\174\163\364\377\312\070\131\162\300\045\214\172\073\306\222"
	"\347\147\061\025\103\120\243\362\050\106\053\015\072\014\037\136"
	"\057\127\302\144\256\024\362\173\215\056\364\372\064\033\262\326"
	"\341\056\030\215\370\100\216\225\175\200\107\313\057\251\065\125"
	"\175\012\347\372\242\130\324\142\313\352\355\156\023\017\237\224"
	"\160\116\035\132\055\027\221\367\320\136\132\107\204\224\341\140"
	"\271\122\060\036\306\220\062\064\233\264\231\165\265\120\303\130"
	"\245\333\004\115\112\253\112\022\107\264\167\204\157\261\231\010"
	"\236\334\052\103\363\361\350\352\231\122\026\065\176\153\104\125"
	"\351\365\345\052\170\142\036\040\367\070\364\051\275\123\054\204"
	"\232\215\355\364\201\046\165\064\367\075\205\204\257\013\106\275"
	"\302\277\053\034\120\077\235\377\073\020\043\143\041\320\224\214"
	"\032\137\004\015\367\003\000\215\146\175\134\166\346\065\164\215"
	"\315\213\117\277\240\214\061\026\324\073\233\030\363\213\137\063"
	"\325\016\223\161\334\152\367\230\157\221\222\267\176\131\112\111"
	"\101\057\251\157\334\113\260\150\062\161\051\370\336\266\253\222"
	"\027\010\056\204\145\311\270\041\044\005\345\327\074\111\172\056"
	"\215\366\173\135\026\151\051\134\242\050\152\072\330\364\313\256"
	"\350\043\264\332\271\160\007\100\135\310\106\103\337\162\346\127"
	"\265\063\216\332\366\212\353\032\075\342\370\333\135\202\044\314"
	"\240\361\270\304\212\375\145\124\343\365\131\073\324\370\113\250"
	"\242\256\107\241\352\370\032\341\135\331\052\234\343\012\144\126"
	"\365\363\117\133\377\232\054\262\022\231\257\033\215\235\231\363"
	"\143\136\024\205\044\340\136\062\037\255\117\173\244\345\054\044"
	"\167\160\374\355\210\076\324\156\100\361\222\275\067\334\043\045"
	"\147\325\110\373\075\121\036\116\164\252\022\322\317\076\353\220"
	"\101\132\120\107\055\022\237\351\051\061\325\244\205\240\277\377"
	"\224\303\150\041\274\261\300\044\310\211\255\047\250\251\375\356"
	"\354\307\363\366\067\312\236\256\000\207\144\021\273\164\304\120"
	"\234\231\007\356\173\034\205\175\123\135\262\101\012\045\177\155"
	"\214\111\056\150\355\217\244\362\045\176\232\227\341\107\275\303"
	"\344\252\010\110\177\170\036\201\031\265\200\321\237\151\260\161"
	"\106\371\265\206\375\374\253\134\044\252\301\340\273\340\052\147"
	"\271\321\055\120\331\312\007\025\145\330\127\235\150\020\264\374"
	"\172\121\225\216\160\025\002\216\074\345\060\316\252\301\227\235"
	"\212\211\001\317\163\362\166\104\276\201\117\144\362\335\330\305"
	"\036\017\167\324\106\117\133\103\341\152\105\063\265\301\356\006"
	"\347\133\174\201\252\064\360\063\257\034\332\004\031\135\076\343"
	"\316\370\371\072\001\161\173\146\055\224\171\024\312\147\150\304"
	"\313\232\261\033\302\323\036\123\246\200\346\173\356\170\306\045"
	"\016\057\316\014\061\354\356\022\322\156\044\051\236\026\101\344"
	"\030\241\030\317\014\305\326\037\016\353\073\114\126\231\371\044"
	"\021\013\272\173\161\376\010\250\153\166\242\330\307\355\367\035"
	"\047\377\265\135\074\212\217\100\043\100\270\076\316\221\347\014"
	"\164\041\101\051\170\314\240\146\055\254\175\264\165\061\142\204"
	"\255\276\345\230\077\326\315\222\166\076\031\102\131\054\305\032"
	"\164\063\122\000\376\250\262\261\167\101\036\133\126\242\254\073"
	"\366\141\155\047\206\352\174\072\055\053\022\253\156\343\344\361"
	"\243\105\231\111\033\303\051\150\325\350\260\257\162\205\303\356"
	"\246\102\240\227\251\307\073\012\326\341\120\220\164\007\011\032"
	"\073\162\317\164\033\117\052\366\346\267\255\021"
#define      tst2_z	19
#define      tst2	((&data[1676]))
	"\045\210\216\266\211\013\352\224\244\237\016\007\137\136\077\165"
	"\002\333\002\303\204\145\205\222\201"
#define      msg1_z	42
#define      msg1	((&data[1699]))
	"\155\060\060\152\241\215\025\033\216\132\255\257\222\101\167\352"
	"\273\030\254\224\314\005\072\034\267\060\201\133\205\224\025\376"
	"\004\012\134\005\321\074\313\176\126\060\345\313\276\135\130\312"
	"\364\204"
#define      shll_z	10
#define      shll	((&data[1749]))
	"\052\037\235\305\101\212\233\272\277\255\336"/* End of data[] */;
#define      hide_z	4096
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	1	/* Define as 1 to enable ptrace the executable */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask  = (unsigned long)&chkenv;
	mask ^= (unsigned long)getpid() * ~mask;
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
#	define PTRACE_ATTACH	PT_ATTACH
#endif
void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PTRACE_ATTACH, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;
	char * me = argv[0];

	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	ret = chkenv(argc);
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		/* Prepend hide_z spaces to script text to hide it. */
		scrpt = malloc(hide_z + text_z);
		if (!scrpt)
			return 0;
		memset(scrpt, (int) ' ', hide_z);
		memcpy(&scrpt[hide_z], text, text_z);
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, me);
		} else {
			scrpt = me;
		}
	}
	j = 0;
	varg[j++] = argv[0];		/* My own name at execution */
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
